<!DOCTYPE html>
<html>

<head lang="en">
    <meta charset="UTF-8">
    <title>Stairway to Health 2 - Presentation</title>
    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/ordina.css" id="theme">
    <link rel="stylesheet" href="css/custom.css">

    <!-- Printing and PDF exports -->
    <script>
		var link = document.createElement('link');
		link.rel = 'stylesheet';
		link.type = 'text/css';
		link.href = window.location.search.match(/print-pdf/gi) ? 'css/print/pdf.css' : 'css/print/paper.css';
		document.getElementsByTagName('head')[0].appendChild(link);
    </script>

    <script src="js/head.min.js"></script>
    <!--Add support for earlier versions of Internet Explorer -->
    <!--[if lt IE 9]>
    <script src="js/html5shiv.js"></script>
    <![endif]-->
</head>

<body>
<div class="reveal">
    <div class="slides">
        <section data-background="img/cover.png">
        </section>

        <section data-background="img/profiles.png">
        </section>

        <!-- Example of nested vertical slides -->
        <section>
            <section data-background-color="#e68308">
                <h2 style="color: #fff;">Quick Recap</h2>
            </section>
            <section>
                <h2>Stairway to Health 1.0 @ Proximus</h2>
                <img height="500" src="img/sth1-showcase.jpg" alt="Stairway to health 1 Showcase">
            </section>
            <section>
                <p>The Stairway to Health project is a simple yet great example to show what the Internet of Things can
                    do:
                <p/>
                <ul>
                    <li> LoRa sensors detect door openings, these are installed on the doors of the staircases</li>
                    <li> These sensors communicate via the LoRa network to report their status</li>
                    <li> In our case sensor data is sent to the Proximus MyThings platform which processes the data</li>
                    <li> The data gets sent to the Stairway to Health application</li>
                    <li> The Stairway to Health application interprets and visualises the data</li>
                </ul>
            </section>
            <section>
                <h3> In summary</h3>
                <ol>
                    <li class="fragment" data-fragment-index="0">We install sensors on the doors (things) to measure
                        usage
                    </li>
                    <li class="fragment" data-fragment-index="1">we analyse the data to persuade people to move more
                    </li>
                    <li class="fragment" data-fragment-index="2">The result is a good example of how IoT can influence
                        our daily lives.
                    </li>
                </ol>
            </section>
            <section>
                <h2>Data Flow</h2>
                <img src="img/scheme-sth2.png" alt="">
            </section>
            <section>
                <img height="500" src="img/sth1-big-screen.jpg" alt="">
                <p>StH on big screen @ Proximus Towers</p>
            </section>
            <section>
                <img height="500" src="img/sth1-door-sensor.jpg" alt="">
                <p>Magnetic pulse door sensors</p>
            </section>
            <section>
                <img height="500" src="img/sht1-many-sensors.jpg" alt="">
                <p>A lot of them!</p>
            </section>
            <section>
                <img height="500" src="img/sth1-poster.jpg" alt="">
                <p>Let the games begin!</p>
            </section>
            <section>
                <h2>Technology used</h2>
                <h4>Frontend</h4>
                <img height="160" src="img/sth1-tech-fe.png" alt="Frontend tech stack">
                <h4>Backend</h4>
                <img height="160" src="img/sth1-tech-be.png" alt="Backend tech stack">
            </section>
            <section>
                <h2>Down</h2>
                <img height="300" src="img/pxs-cloud-down.png" alt="proximus cloud down">
            </section>
            <section>
                <h2>Soon up again</h2>
                <img height="300" src="img/openshift-logo.png" alt="proximus cloud down">
            </section>
            <section>
                <h2>Read more @ our blog</h2>
                <a href="https://ordina-jworks.github.io/iot/2017/10/12/Stairway-To-Health.html">https://ordina-jworks.github.io/iot/2017/10/12/Stairway-To-Health.html</a>
            </section>
        </section>

        <section>
            <section data-background-color="#e68308">
                <h2 style="color: #fff;">Stairway to Health @ Ordina</h2>
                <h4 style="color: #fff;">(v2.0)</h4>
            </section>
            <section>
                <h2>Harder, Better, Faster, Stronger</h2>
                <img height="500" src="img/sth2-showcase.jpg" alt="">
            </section>
            <section>
                <h2>What's new?</h2>
                <ul>
                    <li> New (and awesome) frontend design,
                        <small style="padding-top: 13px;">with Ordina theming obviously</small>
                    </li>
                    <li> Upgraded from Angular 4 to Angular 5</li>
                    <li> Material Design</li>
                    <li> NEST.js in stead of Express.js
                        <small style="padding-top: 13px;">(still Express underneath, but cleaner code!)</small>
                    </li>
                    <li> Eliminated 'callback hell' with async/await</li>
                    <li> Backend e2e tests with Mockgoose</li>
                    <li> Optimised the storage of our logs for more performance</li>
                    <li> Deployed on OpenShift</li>
                    <li> New type of sensors</li>
                    <li> Cheers feature, users can motivate and support each other</li>
                </ul>
            </section>
            <section>
                <h2>New (and awesome) frontend design</h2>
                <a href="http://sth2-fe-prod-ordina-stairway-to-health.origin.ordina-jworks.io/dashboard"
                   target="_blank">Stairway to Health 2.0</a>
            </section>
            <section>
                <h2>New Tech Stack</h2>
                <h4>Frontend</h4>
                <img height="180" src="img/sth2-tech-fe.png" alt="">
                <h4>Backend</h4>
                <img height="180" src="img/sth2-tech-be.png" alt="">
            </section>
            <section>
                <h2>NEST.js vs Express.js</h2>
                <p class="fragment" data-fragment-index="0">Still express underneath</p>
                <p class="fragment" data-fragment-index="1">Cleaner code (typescript decorators)</p>
                <p class="fragment" data-fragment-index="2">Easier set-up</p>
                <p class="fragment" data-fragment-index="3">Common (Modular) structure</p>
                <p class="fragment" data-fragment-index="4">Guards, Sockets, Interceptors, ... </p>
                <p class="fragment" data-fragment-index="5">Own custom decorators, (RoleGuard)</p>
            </section>
            <section>
                <h2>NEST.js vs Express.js</h2>
                <pre><code data-trim contenteditable>
@Controller('/auth/logs')
@UseGuards(RolesGuard)
export class LogAuthController {
    // logs-auth.controller.ts
    @Get('/total')
    @Roles('admin') // Decorator for roles guard we wrote to make sure user is logged in, and has correct role
    async getLogCount(): Promise&lt;number&gt; {
        return await this.logService.getLogCount();
    }
}

// logs.service.ts
async getLogCount(): Promise&lt;number&gt; {
    try {
        return await this.logModel.count({});
    } catch (error) {
        throw new HttpException('Error getting logs', HttpStatus.INTERNAL_SERVER_ERROR);
    }
}
                </code></pre>

            </section>
            <section>
                <h2>Backend E2E Tests with Mockgoose</h2>
                <p>Mockgoose is a wrapper for mongoose, that lets you connect to a non persistent database if you want
                    to.</p>
            </section>
            <section>
                <p>So in our database provider we can use something like the following:</p>

                <pre><code data-trim>
if (process.env.NODE_ENV === 'test') {
    const mockgoose = new Mockgoose(mongoose);
    mockgoose.helper.setDbVersion('3.6.0');
    mockgoose.prepareStorage()
        .then(async () => {
            await mongoose.connect('mongodb://localhost:27017/stairwaytohealth2test', {
            useMongoClient: true
        });
    }).catch(() => {
        console.log('ERR! Unable to prepare test database');
    });
} else { // connect to the database normally }
                </code></pre>

                and before, afterwards or in our tests, we can use
                <pre><code data-trim>mockgoose.helper.reset(callback)</code></pre>
                to clear out all our collections.

            </section>
            <section>
                <h2>Optimised the storage of our logs for more performance</h2>
                <p>With Stairway to Health 1, we use mongo aggregate's to group the data from our logs.</p>
                <p>This meant that every time we want the data, we calculate it.</p>
                <p>As you can imagine, there was a performance issue once we hit 2M logs</p>
            </section>
            <section>
                <h2>Solution</h2>
                <p>More collections...</p>
                <p>so in stead of calculating everytime we want the data, we update a collection that keeps track of the
                    totals every time a log comes in.</p>
            </section>
            <section>
                <h2>Before</h2>
                <pre><code data-trim>
this.sensorLogModel.aggregate({
        '$project': {
            'value': 1,
            'container': 1,
            'timestamp': 1,
            '_id': 1,
            'friendlyName1': 1
        }
    },{
        '$match': {
            'friendlyName1': entity.friendlyName1,
            'container': entity.container,
            'value': {$ne: '0'},
            'timestamp': {
                $gt: timespan.start,
                $lt: timespan.end
            }
        }
    },{
        '$group': {
            '_id': '$friendlyName1',
            'count': {$sum: '$value'},
        }
    }
)
                </code></pre>
            </section>
            <section>
                <h2>After</h2>
                <pre><code data-trim>
// note that we put it in a variable, so it's not blocking ('awaiting')
let dailyCountPromise = this.dailyCountsModel.update({
    identifier: dailyIdentifier,
    friendlyName1: item.friendlyName1,
    friendlyName2: item.friendlyName2,
    hour: item.hour
}, {
    $inc: {counts: item.numericValue}
}, {upsert: true});
                </code></pre>
                <p class="fragment" data-fragment-index="0">We do this for all chart types</p>
                <pre class="fragment" data-fragment-index="0"><code data-trim>
let weeklyCountPromise = this.weeklyCountsModel.update( ... );
let monthlyCountPromise = this.monthlyCountsModel.update( ... );
let yearlyCountPromise = this.yearlyCountsModel.update( ... );
let totalCountPromise = this.totalCountsModel.update( ... );
                </code></pre>
                <small class="fragment" data-fragment-index="1">since we put them in variables and don't await them, the
                    code is not blocking,
                    all request to the database will be made one after the other, and we can still continue in our code.
                    With the variables, we can still do a Promise.all if we wanted to.
                </small>
                <pre class="fragment" data-fragment-index="1"><code>Promise.all([weeklyCountPromise, monthlyCountPromise, ...])</code></pre>

            </section>
            <section>
                <h2>Example Data DailyCounts</h2>
                <pre><code data-trim>
{
  "date": {
    "$date": "2017-12-20T21:49:15.532Z"
  },
  "friendlyName1": "C",
  "friendlyName2": "1",
  "hour": 22,
  "identifier": "20-12-2017",
  "counts": 55
}
                </code></pre>
            </section>
        </section>
        <section>
            <section data-background-color="#e68308">
                <h2 style="color: #fff;">Deploying</h2>
                <img src="img/openshift-logo.png" height="200" alt="">
            </section>
            <section>
                <h2>Why OpenShift</h2>
                <ul>
                    <li>Easy to set up (demo git repo to get started from)</li>
                    <li>Scalable</li>
                    <li>Easy deployment (Continuous Integration)</li>
                </ul>
            </section>
            <section>
                <h2>Continuous Integration</h2>
                <p>Continuous Integration (CI) is a development practice that requires developers to integrate
                    code into a shared repository several times a day. Each check-in is then verified by an automated
                    build, allowing teams to detect problems early.
                </p>
                <ul>
                    <li>Say goodbye to long and tense integrations</li>
                    <li>Catch issues early and nip them in the bud</li>
                    <li>Spend less time debugging and more time adding features</li>
                    <li>Stop waiting to find out if your codeâ€™s going to work</li>
                    <li>Reduce integration problems allowing you to deliver software more rapidly</li>
                </ul>
            </section>
            <section>
                <h2>Setup with git(hub)</h2>
                <p>When creating the openshift application we get asked for a github url and optionally a branch</p>
                <img src="img/github-url.png" alt="">
                <p>Once created we get a Webhook URL from OpenShift, that we can then add to our repositories webhooks.</p>
                <p>Whenever we push to the repository, the webhook gets triggered, and openshift starts a new build.</p>
            </section>
            <section>
                <h2>Environments</h2>
                <ul>
                    <li>We've set up 2 environments, develop and production.</li>
                    <li>Therefore we have linked both our master and develop branch to an OpenShift application.</li>
                    <li>When we develop, we create a feature branch, once it runs and works locally, we merge it into
                        develop.
                    </li>
                    <li>When merging in develop (and pushing to github), it gets deployed on our OpenShift dev
                        application.
                    </li>
                    <li>Once the feature is ready and tested, we create a pull request to merge our develop branch into
                        master
                    </li>
                    <li>Which triggers a deploy of our production environment</li>
                </ul>
            </section>
            <section>
                <img src="img/gitflow.png" alt="">
            </section>
        </section>

        <section>
            <section data-background-color="#e68308">
                <h2 style="color: #fff;">New sensor type</h2>
                <h4 style="color: #fff;">MySense</h4>
            </section>

            <section>
                <!-- **********
                @ AXEL: YOUR SHIZZLE GOES HERE!
                ********** -->
            </section>
        </section>
        <section>
            <img src="img/kickass.gif" alt="" height="500px">
        </section>

        <!-- **********
            DO NOT REMOVE
        ********** -->
        <section style="text-align: left;">
            <h2>Thanks for watching!</h2>
            <p class="fragment">Now kick some ass!</p>
        </section>

        <section style="text-align: left;" data-background="img/jworks-wallpaper-3.jpg"></section>
    </div>
</div>
<script src="js/reveal.js"></script>
<script>
	Reveal.initialize({
		transition: 'convex',
		dependencies: [
			// Cross-browser shim that fully implements classList - https://github.com/eligrey/classList.js/
			{
				src: 'lib/js/classList.js',
				condition: function () {
					return !document.body.classList;
				}
			},
			// Interpret Markdown in <section> elements
			{
				src: 'plugin/markdown/marked.js',
				condition: function () {
					return !!document.querySelector('[data-markdown]');
				}
			},
			{
				src: 'plugin/markdown/markdown.js',
				condition: function () {
					return !!document.querySelector('[data-markdown]');
				}
			},
			// Syntax highlight for <code> elements
			{
				src: 'plugin/highlight/highlight.js',
				async: true,
				callback: function () {
					hljs.initHighlightingOnLoad();
				}
			},
			// Zoom in and out with Alt+click
			{
				src: 'plugin/zoom-js/zoom.js',
				async: true
			},
			// Speaker notes
			{
				src: 'plugin/notes/notes.js',
				async: true
			}
		]
	});
</script>
</body>

</html>
